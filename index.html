<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>‚ú® –ö–ª–∏–∫–µ—Ä Pro ‚Äî –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  
  <!-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï FIREBASE (—á–µ—Ä–µ–∑ CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #162341);
      color: white;
      overflow: hidden;
      height: 100vh;
    }
    .screen { 
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #authScreen, #emailScreen, #serversScreen, #friendsScreen { display: flex; }
    #menu, #gameUI { display: none; }
    
    .btn {
      padding: 14px 28px;
      margin: 12px 0;
      width: 90%;
      max-width: 340px;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-primary { background: linear-gradient(45deg, #4ecca3, #2a9d8f); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.15); color: white; }
    .btn-danger { background: linear-gradient(45deg, #e94560, #d0003a); color: white; }
    .btn-sm {
      padding: 8px 16px;
      width: auto;
      font-size: 14px;
      margin: 0 5px;
    }
    
    .input-field {
      padding: 14px;
      width: 90%;
      max-width: 340px;
      text-align: center;
      border-radius: 16px;
      border: 2px solid rgba(78,204,163,0.5);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 18px;
      margin: 12px 0;
      backdrop-filter: blur(4px);
    }
    
    .menu-header {
      margin-bottom: 30px;
      text-align: center;
    }
    .menu-title {
      font-size: 32px;
      background: linear-gradient(45deg, #4ecca3, #f4a261);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    
    /* –ü—Ä–æ—Ñ–∏–ª—å */
    #profilePanel {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0,0,0,0.3);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
    }
    #profileAvatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(45deg, #4ecca3, #2a9d8f);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }
    #profileName { font-size: 16px; font-weight: 600; }
    
    /* –í–∫–ª–∞–¥–∫–∏ */
    .tabs {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .tab-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .tab-btn.active {
      background: linear-gradient(45deg, #4ecca3, #2a9d8f);
    }
    
    /* –°–ø–∏—Å–∫–∏ */
    .list-container {
      width: 90%;
      max-width: 340px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 16px;
      margin: 10px 0;
    }
    .list-item {
      padding: 12px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .server-icon { font-size: 24px; margin-right: 10px; }
    
    /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
    #gameContainer {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #gameCanvas {
      background: #0a0a14;
      display: block;
      width: 100%;
      height: 100%;
    }
    #minimap {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 130px;
      height: 90px;
      background: rgba(0,0,0,0.4);
      border: 2px solid #4ecca3;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .game-overlay {
      position: absolute;
      padding: 10px 18px;
      background: rgba(0,0,0,0.4);
      border-radius: 20px;
      font-size: 18px;
      font-weight: 600;
      backdrop-filter: blur(4px);
    }
    #scoreDisplay { top: 20px; left: 20px; }
    #playersList { 
      position: absolute;
      top: 70px;
      left: 20px;
      width: 200px;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border-radius: 16px;
    }
    #leaveBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="authScreen" class="screen">
  <div class="menu-header">
    <div class="menu-title">‚ú® –ö–ª–∏–∫–µ—Ä Pro</div>
  </div>
  <button class="btn btn-primary" onclick="signInWithGoogle()">üîê Google</button>
  <button class="btn btn-secondary" onclick="showEmailScreen()">üìß Email</button>
  <button class="btn btn-secondary" onclick="signInAnonymously()">üë§ –ì–æ—Å—Ç—å</button>
</div>

<!-- Email -->
<div id="emailScreen" class="screen" style="display:none;">
  <div class="menu-header">
    <div class="menu-title">üìß –í—Ö–æ–¥</div>
  </div>
  <input type="email" id="emailInput" class="input-field" placeholder="Email" />
  <input type="password" id="passwordInput" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å" />
  <button class="btn btn-primary" onclick="handleEmailAuth()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button class="btn btn-secondary" onclick="showAuthScreen()">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –°–µ—Ä–≤–µ—Ä—ã -->
<div id="serversScreen" class="screen" style="display:none;">
  <div class="menu-header">
    <div class="menu-title">üåê –°–µ—Ä–≤–µ—Ä—ã</div>
  </div>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="showServerTab('public')">–ü—É–±–ª–∏—á–Ω—ã–µ</button>
    <button class="tab-btn" onclick="showServerTab('create')">–°–æ–∑–¥–∞—Ç—å</button>
  </div>
  
  <div id="publicServers">
    <div id="serversList" class="list-container"></div>
  </div>
  
  <div id="createServer" style="display:none;">
    <input type="text" id="serverName" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞" />
    <div style="margin: 15px 0; color: #a0a0c0;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É:</div>
    <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
      <span class="server-icon" data-icon="üåç">üåç</span>
      <span class="server-icon" data-icon="üéÆ">üéÆ</span>
      <span class="server-icon" data-icon="üî•">üî•</span>
      <span class="server-icon" data-icon="üèÜ">üèÜ</span>
      <span class="server-icon" data-icon="üëæ">üëæ</span>
    </div>
    <button class="btn btn-primary" onclick="createServer()">üöÄ –°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π</button>
    <input type="text" id="privateCode" class="input-field" placeholder="–ö–æ–¥ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞" />
    <button class="btn btn-secondary" onclick="joinPrivateServer()">üîí –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ –∫–æ–¥—É</button>
  </div>
  
  <button class="btn btn-secondary" onclick="showMainMenu()">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –î—Ä—É–∑—å—è -->
<div id="friendsScreen" class="screen" style="display:none;">
  <div class="menu-header">
    <div class="menu-title">üë• –î—Ä—É–∑—å—è</div>
  </div>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="showFriendsTab('list')">–°–ø–∏—Å–æ–∫</button>
    <button class="tab-btn" onclick="showFriendsTab('requests')">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</button>
  </div>
  
  <div id="friendsList" class="list-container"></div>
  <div id="friendRequests" class="list-container" style="display:none;"></div>
  
  <button class="btn btn-secondary" onclick="showMainMenu()">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="menu" class="screen" style="display:none;">
  <div class="menu-header">
    <div class="menu-title">‚ú® –ö–ª–∏–∫–µ—Ä Pro</div>
  </div>
  
  <div id="profilePanel" onclick="showAuthScreen()">
    <div id="profileAvatar">üë§</div>
    <div id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
  
  <button class="btn btn-primary" onclick="showServersScreen()">üåê –°–µ—Ä–≤–µ—Ä—ã</button>
  <button class="btn btn-secondary" onclick="showFriendsScreen()">üë• –î—Ä—É–∑—å—è</button>
  <button class="btn btn-danger" onclick="signOut()">–í—ã–π—Ç–∏</button>
</div>

<!-- –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="gameUI">
  <div id="gameContainer">
    <canvas id="gameCanvas" width="1500" height="1000"></canvas>
    <div id="scoreDisplay" class="game-overlay">–°—á—ë—Ç: 0</div>
    <button id="leaveBtn" class="btn btn-danger" onclick="leaveGame()">üö™ –í—ã–π—Ç–∏</button>
    <div id="playersList"></div>
    <canvas id="minimap" width="130" height="90"></canvas>
  </div>
</div>

<script>
  // === –¢–í–û–ô FIREBASE CONFIG ===
  const firebaseConfig = {
    apiKey: "AIzaSyB03njAHYVQ2VI5-0-rOTR39pW0ggPqDus",
    authDomain: "ball-game-53e49.firebaseapp.com",
    databaseURL: "https://ball-game-53e49-default-rtdb.firebaseio.com",
    projectId: "ball-game-53e49",
    storageBucket: "ball-game-53e49.firebasestorage.app",
    messagingSenderId: "895128807264",
    appId: "1:895128807264:web:019538a33ed810c55ba005"
  };

  // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (—Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!)
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
  // (–≤—Å—ë, —á—Ç–æ –±—ã–ª–æ –Ω–∏–∂–µ ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let currentUser = null;
  let currentRoom = null;
  let playerId = null;
  let players = {};
  let score = 0;
  let gameActive = false;
  let canvas, ctx, minimapCtx;
  const WORLD_WIDTH = 1500;
  const WORLD_HEIGHT = 1000;
  let selectedServerIcon = 'üåç';

  // === –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
  function showAuthScreen() {
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('emailScreen').style.display = 'none';
    document.getElementById('serversScreen').style.display = 'none';
    document.getElementById('friendsScreen').style.display = 'none';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('gameUI').style.display = 'none';
  }
  
  function showEmailScreen() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('emailScreen').style.display = 'flex';
  }
  
  function showServersScreen() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('serversScreen').style.display = 'flex';
    loadPublicServers();
  }
  
  function showFriendsScreen() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('friendsScreen').style.display = 'flex';
    loadFriends();
    loadFriendRequests();
  }
  
  function showMainMenu() {
    document.getElementById('menu').style.display = 'flex';
    document.getElementById('serversScreen').style.display = 'none';
    document.getElementById('friendsScreen').style.display = 'none';
    document.getElementById('gameUI').style.display = 'none';
  }
  
  function showServerTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('publicServers').style.display = tab === 'public' ? 'block' : 'none';
    document.getElementById('createServer').style.display = tab === 'create' ? 'block' : 'none';
  }
  
  function showFriendsTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('friendsList').style.display = tab === 'list' ? 'block' : 'none';
    document.getElementById('friendRequests').style.display = tab === 'requests' ? 'block' : 'none';
  }

  // === –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ===
  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  }

  function signInAnonymously() {
    auth.signInAnonymously().catch(console.error);
  }

  function handleEmailAuth() {
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    if (!email || !password || password.length < 6) {
      alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .catch(error => {
        if (error.code === 'auth/user-not-found') {
          auth.createUserWithEmailAndPassword(email, password);
        }
      });
  }

  function signOut() {
    auth.signOut().then(showAuthScreen);
  }

  // === –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ===
  async function saveUserData() {
    if (!currentUser) return;
    const userRef = database.ref(`users/${currentUser.uid}`);
    const displayName = currentUser.displayName || currentUser.email || "–ò–≥—Ä–æ–∫";
    await userRef.update({
      displayName: displayName,
      lastLogin: firebase.database.ServerValue.TIMESTAMP
    });
  }

  // === –°–ï–†–í–ï–†–´ ===
  function selectServerIcon(icon) {
    selectedServerIcon = icon;
    document.querySelectorAll('.server-icon').forEach(el => {
      el.style.transform = el.dataset.icon === icon ? 'scale(1.2)' : 'scale(1)';
      el.style.filter = el.dataset.icon === icon ? 'brightness(1.5)' : 'brightness(1)';
    });
  }

  async function createServer() {
    const name = document.getElementById('serverName').value.trim();
    if (!name) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞");
      return;
    }
    const serverId = 'server_' + Date.now().toString(36).substr(2, 6);
    await database.ref(`servers/${serverId}`).set({
      name: name,
      icon: selectedServerIcon,
      public: true,
      lastActive: firebase.database.ServerValue.TIMESTAMP
    });
    joinRoom(serverId);
  }

  function joinPrivateServer() {
    const code = document.getElementById('privateCode').value.trim();
    if (!code) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–µ—Ä–≤–µ—Ä–∞");
      return;
    }
    joinRoom(code);
  }

  async function loadPublicServers() {
    const container = document.getElementById('serversList');
    container.innerHTML = '<div style="text-align:center;color:#aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    // –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
    const mainDiv = document.createElement('div');
    mainDiv.className = 'list-item';
    mainDiv.innerHTML = `<span class="server-icon">üè†</span> –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä`;
    mainDiv.onclick = () => joinRoom('main-server');
    container.innerHTML = '';
    container.appendChild(mainDiv);
    
    // –ü—É–±–ª–∏—á–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
    const serversRef = database.ref('servers');
    const snapshot = await serversRef.orderByChild('public').equalTo(true).limitToLast(20).once('value');
    let count = 0;
    snapshot.forEach(serverSnap => {
      count++;
      const serverData = serverSnap.val();
      if (Date.now() - serverData.lastActive < 300000) { // –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `<span class="server-icon">${serverData.icon}</span> ${serverData.name}`;
        div.onclick = () => joinRoom(serverSnap.key);
        container.appendChild(div);
      }
    });
    
    if (count === 0) {
      container.innerHTML += '<div style="text-align:center;color:#666;margin-top:10px;">–ù–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</div>';
    }
  }

  // === –î–†–£–ó–¨–Ø ===
  async function loadFriends() {
    if (!currentUser) return;
    const container = document.getElementById('friendsList');
    container.innerHTML = '<div style="text-align:center;color:#aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const userRef = database.ref(`users/${currentUser.uid}`);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val() || {};
    const friendIds = userData.friends || [];
    
    const friends = [];
    for (const fid of friendIds) {
      const friendSnap = await database.ref(`users/${fid}`).once('value');
      const friendData = friendSnap.val();
      if (friendData) {
        friends.push({ id: fid, name: friendData.displayName || "–ò–≥—Ä–æ–∫" });
      }
    }
    
    container.innerHTML = '';
    if (friends.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#666;">–ù–µ—Ç –¥—Ä—É–∑–µ–π</div>';
      return;
    }
    
    friends.forEach(f => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <span>${f.name}</span>
        <button class="btn btn-sm btn-danger" onclick="removeFriend('${f.id}')">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      container.appendChild(div);
    });
  }

  async function loadFriendRequests() {
    if (!currentUser) return;
    const container = document.getElementById('friendRequests');
    container.innerHTML = '<div style="text-align:center;color:#aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const requestsRef = database.ref(`friendRequests/${currentUser.uid}`);
    const snapshot = await requestsRef.once('value');
    const requests = snapshot.val() || {};
    
    container.innerHTML = '';
    let hasRequests = false;
    for (const senderId in requests) {
      hasRequests = true;
      const senderSnap = await database.ref(`users/${senderId}`).once('value');
      const senderName = senderSnap.val()?.displayName || "–ò–≥—Ä–æ–∫";
      
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <span>${senderName}</span>
        <div>
          <button class="btn btn-sm btn-primary" onclick="acceptFriendRequest('${senderId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
          <button class="btn btn-sm btn-danger" onclick="declineFriendRequest('${senderId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      `;
      container.appendChild(div);
    }
    
    if (!hasRequests) {
      container.innerHTML = '<div style="text-align:center;color:#666;">–ù–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</div>';
    }
  }

  async function inviteFriend(friendId) {
    if (!currentUser || friendId === currentUser.uid) return;
    await database.ref(`friendRequests/${friendId}/${currentUser.uid}`).set(true);
    alert("–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
  }

  async function acceptFriendRequest(senderId) {
    // –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
    const userRef = database.ref(`users/${currentUser.uid}/friends`);
    const snapshot = await userRef.once('value');
    const friends = snapshot.val() || [];
    if (!friends.includes(senderId)) {
      friends.push(senderId);
      await userRef.set(friends);
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å –∏ —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    const senderRef = database.ref(`users/${senderId}/friends`);
    const senderSnap = await senderRef.once('value');
    const senderFriends = senderSnap.val() || [];
    if (!senderFriends.includes(currentUser.uid)) {
      senderFriends.push(currentUser.uid);
      await senderRef.set(senderFriends);
    }
    
    // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å
    await database.ref(`friendRequests/${currentUser.uid}/${senderId}`).remove();
    loadFriendRequests();
    loadFriends();
  }

  async function declineFriendRequest(senderId) {
    await database.ref(`friendRequests/${currentUser.uid}/${senderId}`).remove();
    loadFriendRequests();
  }

  async function removeFriend(friendId) {
    if (!currentUser) return;
    const userRef = database.ref(`users/${currentUser.uid}/friends`);
    const snapshot = await userRef.once('value');
    const friends = (snapshot.val() || []).filter(id => id !== friendId);
    await userRef.set(friends);
    loadFriends();
  }

  // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê ===
  function generatePlayerSkin() {
    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22'];
    const eyes = ['‚ö™', 'üëÅÔ∏è', 'üëÄ'];
    const hats = ['‚Äî', 'üéì', 'üëë', 'üé©', 'üëí'];
    return {
      color: colors[Math.floor(Math.random() * colors.length)],
      eyes: eyes[Math.floor(Math.random() * eyes.length)],
      hat: hats[Math.floor(Math.random() * hats.length)]
    };
  }

  // === –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ===
  async function joinRoom(roomId) {
    if (!currentUser) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");
      return;
    }
    
    currentRoom = roomId;
    playerId = currentUser.uid;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∏–Ω–∞
    let skin = generatePlayerSkin();
    const userSnap = await database.ref(`users/${playerId}`).once('value');
    const userData = userSnap.val();
    if (userData && userData.skin) {
      skin = userData.skin;
    } else {
      await database.ref(`users/${playerId}/skin`).set(skin);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
    if (roomId !== 'main-server' && !roomId.includes('private_')) {
      database.ref(`servers/${roomId}/lastActive`).set(firebase.database.ServerValue.TIMESTAMP);
    }
    
    document.getElementById('menu').style.display = 'none';
    document.getElementById('serversScreen').style.display = 'none';
    document.getElementById('gameUI').style.display = 'block';
    
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    minimapCtx = document.getElementById('minimap').getContext('2d');
    
    const startX = Math.random() * (WORLD_WIDTH - 100) + 50;
    const startY = Math.random() * (WORLD_HEIGHT - 100) + 50;
    
    players[playerId] = { 
      x: startX, 
      y: startY, 
      name: userData?.displayName || "–ò–≥—Ä–æ–∫",
      skin: skin
    };
    
    const roomRef = database.ref(`rooms/${roomId}`);
    await roomRef.child(`players/${playerId}`).set(players[playerId]);
    roomRef.child(`players/${playerId}`).onDisconnect().remove();
    
    roomRef.child('players').on('value', snapshot => {
      players = snapshot.val() || {};
      updatePlayersList();
    });
    
    score = 0;
    gameActive = true;
    document.getElementById('scoreDisplay').textContent = `–°—á—ë—Ç: ${score}`;
    
    function handleInteraction(clientX, clientY) {
      if (!gameActive) return;
      const rect = canvas.getBoundingClientRect();
      const clickX = clientX - rect.left;
      const clickY = clientY - rect.top;
      
      let closestPlayer = null;
      let minDist = 50;
      for (const id in players) {
        const p = players[id];
        if (!p) continue;
        const dist = Math.hypot(p.x - clickX, p.y - clickY);
        if (dist < minDist) {
          minDist = dist;
          closestPlayer = id;
        }
      }
      
      if (closestPlayer === playerId) {
        if (Date.now() - (window.lastClick || 0) < 100) return;
        window.lastClick = Date.now();
        score++;
        document.getElementById('scoreDisplay').textContent = `–°—á—ë—Ç: ${score}`;
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞ –∫–∞–∂–¥—ã–µ 100 –æ—á–∫–æ–≤
        if (score % 100 === 0) {
          database.ref('leaderboard').push({
            name: userData?.displayName || "Anonymous",
            score: score,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
        }
      }
    }
    
    canvas.addEventListener('click', e => handleInteraction(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      handleInteraction(e.touches[0].clientX, e.touches[0].clientY);
    });
    
    gameLoop();
  }

  function updatePlayersList() {
    const container = document.getElementById('playersList');
    container.innerHTML = '<div style="color:#a0a0c0; margin-bottom:10px;">–ò–≥—Ä–æ–∫–∏:</div>';
    
    for (const id in players) {
      const p = players[id];
      if (!p) continue;
      
      const div = document.createElement('div');
      div.style.padding = '6px 0';
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.innerHTML = `
        <span>${p.name}</span>
        ${id !== playerId ? `<button class="btn btn-sm btn-secondary" onclick="inviteFriend('${id}')">+</button>` : ''}
      `;
      container.appendChild(div);
    }
  }

  function gameLoop() {
    if (!gameActive) return;
    
    ctx.clearRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
    
    const cellSize = 50;
    for (let x = 0; x < WORLD_WIDTH; x += cellSize) {
      for (let y = 0; y < WORLD_HEIGHT; y += cellSize) {
        const isLight = (Math.floor(x / cellSize) + Math.floor(y / cellSize)) % 2 === 0;
        ctx.fillStyle = isLight ? '#2ecc71' : '#27ae60';
        ctx.fillRect(x, y, cellSize, cellSize);
      }
    }
    
    for (const id in players) {
      const p = players[id];
      if (!p || !p.skin) continue;
      
      ctx.fillStyle = p.skin.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 22, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(p.x - 7, p.y - 5, 6, 0, Math.PI * 2);
      ctx.arc(p.x + 7, p.y - 5, 6, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = 'black';
      ctx.beginPath();
      ctx.arc(p.x - 7, p.y - 5, 2.5, 0, Math.PI * 2);
      ctx.arc(p.x + 7, p.y - 5, 2.5, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      if (p.skin.hat !== '‚Äî') {
        ctx.fillText(p.skin.hat, p.x, p.y - 28);
      }
      
      ctx.fillStyle = 'white';
      ctx.font = '14px Arial';
      ctx.fillText(p.name, p.x, p.y - 42);
    }
    
    minimapCtx.fillStyle = 'rgba(10,10,20,0.7)';
    minimapCtx.fillRect(0, 0, 130, 90);
    minimapCtx.strokeStyle = '#4ecca3';
    minimapCtx.strokeRect(0, 0, 130, 90);
    
    const mapScaleX = 130 / WORLD_WIDTH;
    const mapScaleY = 90 / WORLD_HEIGHT;
    for (const id in players) {
      const p = players[id];
      if (!p) continue;
      const mx = p.x * mapScaleX;
      const my = p.y * mapScaleY;
      minimapCtx.fillStyle = id === playerId ? '#4ecca3' : '#e94560';
      minimapCtx.beginPath();
      minimapCtx.arc(mx, my, 4, 0, Math.PI * 2);
      minimapCtx.fill();
    }
    
    requestAnimationFrame(gameLoop);
  }

  function leaveGame() {
    if (currentRoom && playerId) {
      database.ref(`rooms/${currentRoom}/players/${playerId}`).remove();
    }
    currentRoom = null;
    players = {};
    document.getElementById('gameUI').style.display = 'none';
    document.getElementById('menu').style.display = 'flex';
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      await saveUserData();
      document.getElementById('profileName').textContent = 
        user.displayName || user.email || "–ò–≥—Ä–æ–∫";
      document.getElementById('profileAvatar').textContent = 
        (user.displayName || user.email || "U")[0].toUpperCase();
      showMainMenu();
    }
  });

  // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–û–í –ü–û –ò–ö–û–ù–ö–ê–ú ===
  document.querySelectorAll('.server-icon').forEach(el => {
    el.addEventListener('click', () => selectServerIcon(el.dataset.icon));
  });
  selectServerIcon('üåç'); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML
  window.inviteFriend = inviteFriend;
  window.removeFriend = removeFriend;
  window.acceptFriendRequest = acceptFriendRequest;
  window.declineFriendRequest = declineFriendRequest;
</script>

</body>
</html>