<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1"/>
  <title>‚öΩ –ú—è—á —Å –≥–ª–∞–∑–∞–º–∏ ‚Äî –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0d0d1a;
      color: white;
      overflow: hidden;
      height: 100vh;
    }
    #menu {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #0d0d1a, #1a1a2e);
    }
    #gameUI { display: none; }
    button {
      padding: 14px 24px;
      margin: 10px 0;
      width: 90%;
      max-width: 320px;
      border: none;
      border-radius: 12px;
      background: #4ecca3;
      color: #0f0f1b;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { opacity: 0.9; }
    #leaveBtn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: auto;
      padding: 8px 16px;
      background: #e94560;
      font-size: 14px;
      border-radius: 20px;
    }
    input {
      padding: 14px;
      width: 90%;
      max-width: 320px;
      text-align: center;
      border-radius: 12px;
      border: 2px solid #4ecca3;
      background: #16213e;
      color: white;
      font-size: 18px;
      margin-bottom: 15px;
    }
    .room-item {
      background: rgba(22, 33, 62, 0.7);
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.2s;
    }
    .room-item:hover { background: rgba(30, 45, 85, 0.8); }
    .room-name { font-weight: bold; color: #4ecca3; }
    .room-info { font-size: 13px; color: #aaa; margin-top: 4px; }
    #gameContainer {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #gameCanvas {
      background: #0a0a14;
      display: block;
    }
    #chatBox {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 300px;
      max-width: calc(100% - 40px);
      background: rgba(10, 10, 20, 0.95);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #chatMessages {
      height: 120px;
      overflow-y: auto;
      background: #0f0f1b;
      padding: 8px;
      border-radius: 8px;
      font-size: 14px;
      color: #eee;
    }
    #chatInput {
      padding: 10px;
      background: #16213e;
      border: 1px solid #4ecca3;
      border-radius: 8px;
      color: white;
      font-size: 16px;
    }
    #playersInfo {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0,0,0,0.5);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 16px;
    }
    #nicknameInput {
      background: #1c2a47;
      border-color: #4ecca3;
    }
  </style>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="menu">
  <h2 style="margin-bottom: 20px; color: #4ecca3; text-shadow: 0 0 10px rgba(78,204,163,0.5);">
    ‚öΩ –ú—è—á —Å –≥–ª–∞–∑–∞–º–∏
  </h2>
  
  <input type="text" id="nicknameInput" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º" maxlength="12" />
  <input type="text" id="roomIdInput" placeholder="–ò–º—è –∫–æ–º–Ω–∞—Ç—ã (–∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)" maxlength="12" />
  
  <button onclick="createOrJoinRoom()">‚ñ∂Ô∏è –°–æ–∑–¥–∞—Ç—å / –í–æ–π—Ç–∏</button>
  
  <div style="margin-top: 25px; width: 90%; max-width: 320px;">
    <h3 style="color: #4ecca3; margin-bottom: 12px;">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã:</h3>
    <div id="roomsContainer" style="max-height: 200px; overflow-y: auto;"></div>
  </div>
</div>

<!-- –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="gameUI">
  <div id="gameContainer">
    <canvas id="gameCanvas" width="3000" height="2000"></canvas>
    <div id="playersInfo">–ò–≥—Ä–æ–∫–æ–≤: 0</div>
    <button id="leaveBtn" onclick="leaveRoom()">üö™ –í—ã–π—Ç–∏</button>
    
    <div id="chatBox">
      <div id="chatMessages"></div>
      <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="60" />
    </div>
  </div>
</div>

<script>
  // === –¢–í–û–ô FIREBASE CONFIG ===
  const firebaseConfig = {
    apiKey: "AIzaSyB03njAHYVQ2VI5-0-rOTR39pW0ggPqDus",
    authDomain: "ball-game-53e49.firebaseapp.com",
    projectId: "ball-game-53e49",
    storageBucket: "ball-game-53e49.firebasestorage.app",
    messagingSenderId: "895128807264",
    appId: "1:895128807264:web:019538a33ed810c55ba005"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let currentRoom = null;
  let playerId = null;
  let playerName = null;
  let players = {};
  let isDragging = false;
  let canvas, ctx;
  const WORLD_WIDTH = 3000;
  const WORLD_HEIGHT = 2000;
  let cameraX = 0, cameraY = 0;
  let roomRef = null;

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
  function genPlayerId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 6);
  }

  // === –ß–ê–¢ ===
  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !currentRoom) return;
    
    const chatRef = database.ref(`rooms/${currentRoom}/chat`);
    chatRef.push({
      name: playerName,
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    input.value = '';
  }

  function setupChat() {
    const chatRef = database.ref(`rooms/${currentRoom}/chat`);
    chatRef.limitToLast(100).on('child_added', (snapshot) => {
      const msg = snapshot.val();
      const div = document.createElement('div');
      div.innerHTML = `<b>[${msg.name}]</b> ${msg.text}`;
      document.getElementById('chatMessages').appendChild(div);
      div.scrollIntoView();
    });
    
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  }

  // === –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–¨ –ù–ò–ö–ù–ï–ô–ú–ê –í –ö–û–ú–ù–ê–¢–ï ===
  function isNicknameAvailable(nickname, players) {
    for (const id in players) {
      if (players[id] && players[id].name === nickname) {
        return false;
      }
    }
    return true;
  }

  // === –ü–û–ö–ò–ù–£–¢–¨ –ö–û–ú–ù–ê–¢–£ ===
  function leaveRoom() {
    if (roomRef) {
      roomRef.child(`players/${playerId}`).remove();
      roomRef = null;
    }
    currentRoom = null;
    playerId = null;
    playerName = null;
    players = {};
    
    document.getElementById('gameUI').style.display = 'none';
    document.getElementById('menu').style.display = 'flex';
    
    // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
    document.getElementById('chatMessages').innerHTML = '';
  }

  // === –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –£–î–ê–õ–ï–ù–ò–ï –ü–†–ò –í–´–•–û–î–ï ===
  function setupDisconnect() {
    if (!currentRoom || !playerId) return;
    const presenceRef = database.ref(`rooms/${currentRoom}/players/${playerId}`);
    presenceRef.onDisconnect().remove();
  }

  // === –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –°–ï–†–í–ï–†–û–í ===
  function loadRoomList() {
    const roomsRef = database.ref('rooms');
    roomsRef.once('value', (snapshot) => {
      const container = document.getElementById('roomsContainer');
      const rooms = [];
      
      snapshot.forEach((roomSnap) => {
        const data = roomSnap.val();
        if (data && data.players) {
          const playerCount = Object.keys(data.players).length;
          if (playerCount > 0) {
            rooms.push({
              id: roomSnap.key,
              players: playerCount,
              lastActive: data.lastActive || 0
            });
          }
        }
      });

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø–æ–ª–Ω—ã–µ
      rooms.sort((a, b) => {
        if (b.players !== a.players) return b.players - a.players;
        return b.lastActive - a.lastActive;
      });

      container.innerHTML = '';
      if (rooms.length === 0) {
        container.innerHTML = '<div style="color:#666;padding:10px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</div>';
        return;
      }

      rooms.slice(0, 10).forEach(room => {
        const now = Date.now();
        const ageMin = Math.floor((now - room.lastActive) / 60000);
        if (ageMin > 5) return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ

        const div = document.createElement('div');
        div.className = 'room-item';
        div.innerHTML = `
          <div class="room-name">${room.id}</div>
          <div class="room-info">–ò–≥—Ä–æ–∫–æ–≤: ${room.players} ‚Ä¢ –ê–∫—Ç–∏–≤–µ–Ω ${ageMin === 0 ? '—Ç–æ–ª—å–∫–æ —á—Ç–æ' : ageMin + ' –º–∏–Ω –Ω–∞–∑–∞–¥'}</div>
        `;
        div.onclick = () => joinRoom(room.id);
        container.appendChild(div);
      });
    });
  }

  // === –í–•–û–î –í –ö–û–ú–ù–ê–¢–£ ===
  function joinRoom(roomId) {
    const nicknameInput = document.getElementById('nicknameInput');
    let nickname = nicknameInput.value.trim();
    if (!nickname) {
      nickname = 'Player' + Math.floor(Math.random() * 1000);
    }
    if (nickname.length > 12) nickname = nickname.substring(0, 12);

    currentRoom = roomId;
    playerId = genPlayerId();
    playerName = nickname;

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä—É
    document.getElementById('menu').style.display = 'none';
    document.getElementById('gameUI').style.display = 'block';

    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');

    // –°–ø–∞–≤–Ω –≤ —Å–ª—É—á–∞–π–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    const startX = Math.random() * (WORLD_WIDTH - 200) + 100;
    const startY = Math.random() * (WORLD_HEIGHT - 200) + 100;
    players[playerId] = { x: startX, y: startY, name: playerName };

    roomRef = database.ref(`rooms/${currentRoom}`);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
    roomRef.child('players').once('value', (snapshot) => {
      const existingPlayers = snapshot.val() || {};
      let finalName = playerName;
      let counter = 1;
      while (!isNicknameAvailable(finalName, existingPlayers)) {
        finalName = playerName + counter;
        counter++;
        if (counter > 100) break;
      }
      playerName = finalName;
      players[playerId].name = playerName;
    });

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤
    roomRef.child('players').on('value', (snapshot) => {
      players = snapshot.val() || {};
      updatePlayersCount(Object.keys(players).length);
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–Ω–∞—Ç—ã
    setInterval(() => {
      if (currentRoom) {
        database.ref(`rooms/${currentRoom}/lastActive`).set(Date.now());
      }
    }, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
    setInterval(() => {
      if (players[playerId]) {
        roomRef.child(`players/${playerId}`).set(players[playerId]);
      }
    }, 100);

    setupChat();
    setupDisconnect();

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–º—ã—à—å + —Ç–∞—á)
    function getWorldPoint(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (clientX - rect.left) + cameraX,
        y: (clientY - rect.top) + cameraY
      };
    }

    function startDrag(x, y) {
      const pt = getWorldPoint(x, y);
      const myBall = players[playerId];
      if (myBall && (pt.x - myBall.x)**2 + (pt.y - myBall.y)**2 <= 400) {
        isDragging = true;
      }
    }

    function moveDrag(x, y) {
      if (!isDragging) return;
      const pt = getWorldPoint(x, y);
      players[playerId].x = pt.x;
      players[playerId].y = pt.y;
    }

    canvas.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY));
    window.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY));
    window.addEventListener('mouseup', () => isDragging = false);

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startDrag(e.touches[0].clientX, e.touches[0].clientY);
    });
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      moveDrag(e.touches[0].clientX, e.touches[0].clientY);
    });
    canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      isDragging = false;
    });

    // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    function gameLoop() {
      // –ö–∞–º–µ—Ä–∞
      if (players[playerId]) {
        cameraX = players[playerId].x - window.innerWidth / 2;
        cameraY = players[playerId].y - window.innerHeight / 2;
        cameraX = Math.max(0, Math.min(cameraX, WORLD_WIDTH - window.innerWidth));
        cameraY = Math.max(0, Math.min(cameraY, WORLD_HEIGHT - window.innerHeight));
      }

      ctx.clearRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      
      // –°–µ—Ç–∫–∞
      ctx.strokeStyle = '#151525';
      ctx.lineWidth = 1;
      for (let x = 0; x < WORLD_WIDTH; x += 100) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, WORLD_HEIGHT); ctx.stroke();
      }
      for (let y = 0; y < WORLD_HEIGHT; y += 100) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(WORLD_WIDTH, y); ctx.stroke();
      }

      // –ò–≥—Ä–æ–∫–∏
      for (const id in players) {
        const p = players[id];
        if (!p) continue;
        const screenX = p.x - cameraX;
        const screenY = p.y - cameraY;
        
        ctx.fillStyle = id === playerId ? '#4ecca3' : '#e94560';
        ctx.beginPath();
        ctx.arc(screenX, screenY, 20, 0, Math.PI * 2);
        ctx.fill();
        
        // –ì–ª–∞–∑–∞
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(screenX - 6, screenY - 4, 5, 0, Math.PI * 2);
        ctx.arc(screenX + 6, screenY - 4, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(screenX - 6, screenY - 4, 2, 0, Math.PI * 2);
        ctx.arc(screenX + 6, screenY - 4, 2, 0, Math.PI * 2);
        ctx.fill();
        
        // –ù–∏–∫–Ω–µ–π–º
        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(p.name, screenX, screenY - 30);
      }

      requestAnimationFrame(gameLoop);
    }
    gameLoop();

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
    setInterval(loadRoomList, 5000);
    loadRoomList();
  }

  function createOrJoinRoom() {
    const input = document.getElementById('roomIdInput');
    let roomId = input.value.trim();
    if (!roomId) {
      roomId = 'room' + Math.floor(Math.random() * 1000);
    }
    joinRoom(roomId);
  }

  function updatePlayersCount(count) {
    document.getElementById('playersInfo').textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${count}`;
  }

  // –ó–∞–ø—É—Å–∫
  loadRoomList();
</script>

</body>
</html>