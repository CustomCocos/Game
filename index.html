<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1"/>
  <title>‚öΩ –ú—è—á —Å –≥–ª–∞–∑–∞–º–∏ ‚Äî –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0d0d1a;
      color: white;
      overflow: hidden;
      height: 100vh;
    }
    #menu {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #0d0d1a, #1a1a2e);
    }
    #gameUI { display: none; }
    button {
      padding: 14px 24px;
      margin: 10px 0;
      width: 90%;
      max-width: 320px;
      border: none;
      border-radius: 12px;
      background: #4ecca3;
      color: #0f0f1b;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { opacity: 0.9; }
    #leaveBtn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: auto;
      padding: 8px 16px;
      background: #e94560;
      font-size: 14px;
      border-radius: 20px;
    }
    input {
      padding: 14px;
      width: 90%;
      max-width: 320px;
      text-align: center;
      border-radius: 12px;
      border: 2px solid #4ecca3;
      background: #16213e;
      color: white;
      font-size: 18px;
      margin-bottom: 15px;
    }
    .skin-option {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin: 5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid transparent;
    }
    .skin-option.selected { border-color: white; transform: scale(1.1); }
    #gameContainer {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #gameCanvas {
      background: #0a0a14;
      display: block;
    }
    #chatBox {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 300px;
      max-width: calc(100% - 40px);
      background: rgba(10, 10, 20, 0.95);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #chatMessages {
      height: 120px;
      overflow-y: auto;
      background: #0f0f1b;
      padding: 8px;
      border-radius: 8px;
      font-size: 16px;
      color: #eee;
      line-height: 1.4;
    }
    #chatInput {
      padding: 10px;
      background: #16213e;
      border: 1px solid #4ecca3;
      border-radius: 8px;
      color: white;
      font-size: 16px;
    }
    #playersInfo {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0,0,0,0.5);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 16px;
    }
    #minimap {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 150px;
      height: 100px;
      background: rgba(0,0,0,0.6);
      border: 2px solid #4ecca3;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="menu">
  <h2 style="margin-bottom: 20px; color: #4ecca3; text-shadow: 0 0 10px rgba(78,204,163,0.5);">
    ‚öΩ –ú—è—á —Å –≥–ª–∞–∑–∞–º–∏
  </h2>
  
  <input type="text" id="nicknameInput" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º" maxlength="12" />
  
  <div style="margin: 15px 0; color: #4ecca3; width: 90%; max-width: 320px;">–í—ã–±–µ—Ä–∏ —Å–∫–∏–Ω:</div>
  <div id="skinSelector" style="display:flex; flex-wrap:wrap; justify-content:center; width:90%; max-width:320px;">
    <div class="skin-option" data-color="#3498db" style="background:#3498db;"></div>
    <div class="skin-option" data-color="#e74c3c" style="background:#e74c3c;"></div>
    <div class="skin-option" data-color="#2ecc71" style="background:#2ecc71;"></div>
    <div class="skin-option" data-color="#f1c40f" style="background:#f1c40f;"></div>
    <div class="skin-option" data-color="#9b59b6" style="background:#9b59b6;"></div>
    <div class="skin-option" data-color="#e67e22" style="background:#e67e22;"></div>
  </div>
  
  <input type="text" id="roomIdInput" placeholder="–ò–º—è –∫–æ–º–Ω–∞—Ç—ã (–∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)" maxlength="12" />
  
  <button onclick="createOrJoinRoom()">‚ñ∂Ô∏è –°–æ–∑–¥–∞—Ç—å / –í–æ–π—Ç–∏</button>
  
  <div style="margin-top: 25px; width: 90%; max-width: 320px;">
    <h3 style="color: #4ecca3; margin-bottom: 12px;">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã:</h3>
    <div id="roomsContainer" style="max-height: 200px; overflow-y: auto;"></div>
  </div>
</div>

<!-- –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="gameUI">
  <div id="gameContainer">
    <canvas id="gameCanvas" width="3000" height="2000"></canvas>
    <div id="playersInfo">–ò–≥—Ä–æ–∫–æ–≤: 0</div>
    <button id="leaveBtn" onclick="leaveRoom()">üö™ –í—ã–π—Ç–∏</button>
    
    <div id="chatBox">
      <div id="chatMessages"></div>
      <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (—ç–º–æ–¥–∑–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã!)" maxlength="60" />
    </div>
    
    <canvas id="minimap" width="150" height="100"></canvas>
  </div>
</div>

<script>
  // === –¢–í–û–ô FIREBASE CONFIG ===
  const firebaseConfig = {
    apiKey: "AIzaSyB03njAHYVQ2VI5-0-rOTR39pW0ggPqDus",
    authDomain: "ball-game-53e49.firebaseapp.com",
    projectId: "ball-game-53e49",
    storageBucket: "ball-game-53e49.firebasestorage.app",
    messagingSenderId: "895128807264",
    appId: "1:895128807264:web:019538a33ed810c55ba005"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // === –ó–í–£–ö–ò ===
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(type) {
    if (!audioContext) return;
    const freq = { join: 440, chat: 330, move: 220 }[type] || 220;
    const oscillator = audioContext.createOscillator();
    const gain = audioContext.createGain();
    oscillator.connect(gain);
    gain.connect(audioContext.destination);
    oscillator.frequency.value = freq;
    gain.gain.value = 0.05;
    oscillator.type = 'sine';
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  }

  // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
  let currentRoom = null;
  let playerId = null;
  let playerName = null;
  let playerColor = '#3498db';
  let players = {};
  let isDragging = false;
  let canvas, ctx, minimapCtx;
  const WORLD_WIDTH = 3000;
  const WORLD_HEIGHT = 2000;
  let cameraX = 0, cameraY = 0;
  let roomRef = null;

  // –í—ã–±–æ—Ä —Å–∫–∏–Ω–∞ (—Ü–≤–µ—Ç–∞)
  let selectedSkin = document.querySelector('.skin-option');
  selectedSkin.classList.add('selected');
  document.querySelectorAll('.skin-option').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.skin-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      playerColor = el.getAttribute('data-color');
    });
  });

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
  function genPlayerId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 6);
  }

  // === –ß–ê–¢ –° –≠–ú–û–î–ó–ò ===
  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !currentRoom) return;
    
    const chatRef = database.ref(`rooms/${currentRoom}/chat`);
    chatRef.push({
      name: playerName,
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    input.value = '';
    playSound('chat');
  }

  function setupChat() {
    const chatMessages = document.getElementById('chatMessages');
    const chatRef = database.ref(`rooms/${currentRoom}/chat`);
    
    const observer = new MutationObserver(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
    observer.observe(chatMessages, { childList: true });

    chatRef.limitToLast(100).on('child_added', (snapshot) => {
      const msg = snapshot.val();
      const div = document.createElement('div');
      // –≠–º–æ–¥–∑–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è UTF-8
      div.textContent = `[${msg.name}]: ${msg.text}`;
      chatMessages.appendChild(div);
    });
    
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  }

  // === –í–•–û–î –í –ö–û–ú–ù–ê–¢–£ ===
  async function joinRoom(roomId) {
    const nicknameInput = document.getElementById('nicknameInput');
    let baseName = nicknameInput.value.trim();
    if (!baseName) baseName = 'Player' + Math.floor(Math.random() * 1000);
    if (baseName.length > 12) baseName = baseName.substring(0, 12);

    currentRoom = roomId;
    playerId = genPlayerId();

    document.getElementById('menu').style.display = 'none';
    document.getElementById('gameUI').style.display = 'block';

    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    const minimap = document.getElementById('minimap');
    minimapCtx = minimap.getContext('2d');

    roomRef = database.ref(`rooms/${currentRoom}`);

    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫
    const playersSnapshot = await roomRef.child('players').once('value');
    const existingPlayers = playersSnapshot.val() || {};
    let finalName = baseName;
    let counter = 1;
    while (Object.values(existingPlayers).some(p => p && p.name === finalName)) {
      finalName = baseName + counter;
      counter++;
    }
    playerName = finalName;

    // –°–ø–∞–≤–Ω
    const startX = Math.random() * (WORLD_WIDTH - 200) + 100;
    const startY = Math.random() * (WORLD_HEIGHT - 200) + 100;
    players[playerId] = { x: startX, y: startY, name: playerName, color: playerColor };

    await roomRef.child(`players/${playerId}`).set(players[playerId]);
    await roomRef.child('lastActive').set(Date.now());

    roomRef.child('players').on('value', (snapshot) => {
      players = snapshot.val() || {};
      updatePlayersCount(Object.keys(players).length);
    });

    setInterval(() => {
      if (currentRoom) {
        database.ref(`rooms/${currentRoom}/lastActive`).set(Date.now());
      }
    }, 30000);

    setInterval(() => {
      if (players[playerId]) {
        roomRef.child(`players/${playerId}`).update({
          x: players[playerId].x,
          y: players[playerId].y
        });
      }
    }, 100);

    setupChat();
    setupDisconnect();
    playSound('join');

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    function getWorldPoint(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (clientX - rect.left) + cameraX,
        y: (clientY - rect.top) + cameraY
      };
    }

    function startDrag(x, y) {
      const pt = getWorldPoint(x, y);
      const myBall = players[playerId];
      if (myBall && (pt.x - myBall.x)**2 + (pt.y - myBall.y)**2 <= 400) {
        isDragging = true;
      }
    }

    function moveDrag(x, y) {
      if (!isDragging) return;
      const pt = getWorldPoint(x, y);
      players[playerId].x = pt.x;
      players[playerId].y = pt.y;
      playSound('move');
    }

    canvas.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY));
    window.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY));
    window.addEventListener('mouseup', () => isDragging = false);

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startDrag(e.touches[0].clientX, e.touches[0].clientY);
    });
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      moveDrag(e.touches[0].clientX, e.touches[0].clientY);
    });
    canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      isDragging = false;
    });

    // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    function gameLoop() {
      if (players[playerId]) {
        cameraX = players[playerId].x - window.innerWidth / 2;
        cameraY = players[playerId].y - window.innerHeight / 2;
        cameraX = Math.max(0, Math.min(cameraX, WORLD_WIDTH - window.innerWidth));
        cameraY = Math.max(0, Math.min(cameraY, WORLD_HEIGHT - window.innerHeight));
      }

      // –ö–ª–µ—Ç—á–∞—Ç–∞—è –∑–µ–º–ª—è
      const cellSize = 50;
      for (let x = 0; x < WORLD_WIDTH; x += cellSize) {
        for (let y = 0; y < WORLD_HEIGHT; y += cellSize) {
          const isLight = (Math.floor(x / cellSize) + Math.floor(y / cellSize)) % 2 === 0;
          ctx.fillStyle = isLight ? '#2ecc71' : '#27ae60';
          ctx.fillRect(x, y, cellSize, cellSize);
        }
      }

      // –ò–≥—Ä–æ–∫–∏ ‚Äî —Ü–≤–µ—Ç–Ω—ã–µ –º—è—á–∏ —Å –≥–ª–∞–∑–∞–º–∏
      for (const id in players) {
        const p = players[id];
        if (!p) continue;
        const screenX = p.x - cameraX;
        const screenY = p.y - cameraY;
        
        // –ú—è—á
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(screenX, screenY, 20, 0, Math.PI * 2);
        ctx.fill();
        
        // –ì–ª–∞–∑–∞
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(screenX - 6, screenY - 4, 5, 0, Math.PI * 2);
        ctx.arc(screenX + 6, screenY - 4, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(screenX - 6, screenY - 4, 2, 0, Math.PI * 2);
        ctx.arc(screenX + 6, screenY - 4, 2, 0, Math.PI * 2);
        ctx.fill();
        
        // –ù–∏–∫
        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(p.name, screenX, screenY - 30);
      }

      // –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞
      minimapCtx.fillStyle = '#0a0a14';
      minimapCtx.fillRect(0, 0, 150, 100);
      minimapCtx.strokeStyle = '#4ecca3';
      minimapCtx.strokeRect(0, 0, 150, 100);
      
      const mapScaleX = 150 / WORLD_WIDTH;
      const mapScaleY = 100 / WORLD_HEIGHT;
      for (const id in players) {
        const p = players[id];
        if (!p) continue;
        const mx = p.x * mapScaleX;
        const my = p.y * mapScaleY;
        minimapCtx.fillStyle = id === playerId ? '#3498db' : '#e74c3c';
        minimapCtx.beginPath();
        minimapCtx.arc(mx, my, 3, 0, Math.PI * 2);
        minimapCtx.fill();
      }

      requestAnimationFrame(gameLoop);
    }
    gameLoop();

    const roomListInterval = setInterval(loadRoomList, 3000);
    window.addEventListener('beforeunload', () => clearInterval(roomListInterval));
    loadRoomList();
  }

  // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
  function setupDisconnect() {
    if (!currentRoom || !playerId) return;
    database.ref(`rooms/${currentRoom}/players/${playerId}`).onDisconnect().remove();
  }

  function loadRoomList() {
    const roomsRef = database.ref('rooms');
    roomsRef.once('value', (snapshot) => {
      const container = document.getElementById('roomsContainer');
      const rooms = [];
      const now = Date.now();
      
      snapshot.forEach((roomSnap) => {
        const data = roomSnap.val();
        if (data && data.players) {
          const playerCount = Object.keys(data.players).length;
          const lastActive = data.lastActive || 0;
          const ageMin = (now - lastActive) / 60000;
          if (playerCount > 0 && ageMin <= 5) {
            rooms.push({ id: roomSnap.key, players: playerCount, lastActive });
          }
        }
      });

      rooms.sort((a, b) => b.players - a.players || b.lastActive - a.lastActive);
      container.innerHTML = rooms.length ? '' : '<div style="color:#666;padding:10px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</div>';

      rooms.slice(0, 10).forEach(room => {
        const ageMin = Math.floor((now - room.lastActive) / 60000);
        const div = document.createElement('div');
        div.className = 'room-item';
        div.innerHTML = `
          <div class="room-name">${room.id}</div>
          <div class="room-info">–ò–≥—Ä–æ–∫–æ–≤: ${room.players} ‚Ä¢ ${ageMin === 0 ? '—Ç–æ–ª—å–∫–æ —á—Ç–æ' : ageMin + ' –º–∏–Ω –Ω–∞–∑–∞–¥'}</div>
        `;
        div.onclick = () => joinRoom(room.id);
        container.appendChild(div);
      });
    });
  }

  function leaveRoom() {
    if (roomRef && playerId) {
      roomRef.child(`players/${playerId}`).remove();
    }
    currentRoom = null;
    playerId = null;
    playerName = null;
    players = {};
    
    document.getElementById('gameUI').style.display = 'none';
    document.getElementById('menu').style.display = 'flex';
    document.getElementById('chatMessages').innerHTML = '';
  }

  function createOrJoinRoom() {
    const input = document.getElementById('roomIdInput');
    let roomId = input.value.trim();
    if (!roomId) {
      roomId = 'room' + Math.floor(Math.random() * 1000);
    }
    joinRoom(roomId);
  }

  function updatePlayersCount(count) {
    document.getElementById('playersInfo').textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${count}`;
  }

  // –ó–∞–ø—É—Å–∫
  loadRoomList();
</script>

</body>
</html>