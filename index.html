<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>‚öΩ –ö–ª–∏–∫–µ—Ä —Å –¥—Ä—É–∑—å—è–º–∏ ‚Äî Firebase</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
    body {
      font-family: system-ui, sans-serif;
      background: #0d0d1a;
      color: white;
      overflow: hidden;
      height: 100vh;
    }
    #authScreen, #menu, #gameUI { 
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #gameUI { display: none; }
    button {
      padding: 14px 24px;
      margin: 10px 0;
      width: 90%;
      max-width: 300px;
      border: none;
      border-radius: 12px;
      background: #4ecca3;
      color: #0f0f1b;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }
    input {
      padding: 14px;
      width: 90%;
      max-width: 300px;
      text-align: center;
      border-radius: 12px;
      border: 2px solid #4ecca3;
      background: #16213e;
      color: white;
      font-size: 18px;
      margin-bottom: 15px;
    }
    .tab-btn {
      background: #16213e;
      color: white;
      margin: 0 5px;
      width: auto;
      padding: 8px 16px;
    }
    .tab-btn.active { background: #4ecca3; color: #0f0f1b; }
    #tabs { margin: 20px 0; }
    #friendsList, #leaderboard {
      width: 90%;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(22,33,62,0.7);
      padding: 10px;
      border-radius: 10px;
    }
    .friend-item, .leader-item {
      padding: 6px;
      margin: 4px 0;
      background: rgba(30,45,85,0.8);
      border-radius: 6px;
    }
    #gameContainer {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #gameCanvas {
      background: #0a0a14;
      display: block;
      width: 100%;
      height: 100%;
    }
    #minimap {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 80px;
      background: rgba(0,0,0,0.6);
      border: 2px solid #4ecca3;
      border-radius: 8px;
    }
    #scoreDisplay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.5);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 18px;
    }
    #timeDisplay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 18px;
    }
    #leaveBtn {
      position: absolute;
      top: 70px;
      right: 20px;
      padding: 6px 12px;
      background: #e94560;
      font-size: 14px;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="authScreen">
  <h2 style="margin-bottom: 30px; color: #4ecca3;">–í–æ–π–¥–∏—Ç–µ –≤ –∏–≥—Ä—É</h2>
  <button onclick="signInWithGoogle()">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
</div>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="menu" style="display:none;">
  <h2 style="margin-bottom: 20px; color: #4ecca3;">‚öΩ –ö–ª–∏–∫–µ—Ä —Å –¥—Ä—É–∑—å—è–º–∏</h2>
  
  <div id="tabs">
    <button class="tab-btn active" onclick="showTab('friends')">–î—Ä—É–∑—å—è</button>
    <button class="tab-btn" onclick="showTab('leaderboard')">–õ–∏–¥–µ—Ä—ã</button>
  </div>
  
  <div id="friendsList"></div>
  <div id="leaderboard" style="display:none;"></div>
  
  <input type="text" id="roomIdInput" placeholder="–ò–º—è –∫–æ–º–Ω–∞—Ç—ã" value="clicker-room" />
  <button onclick="joinGame()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<!-- –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="gameUI">
  <div id="gameContainer">
    <canvas id="gameCanvas" width="1500" height="1000"></canvas>
    <div id="scoreDisplay">–°—á—ë—Ç: 0</div>
    <div id="timeDisplay">–í—Ä–µ–º—è: 60</div>
    <button id="leaveBtn" onclick="leaveGame()">üö™ –í—ã–π—Ç–∏</button>
    <canvas id="minimap" width="120" height="80"></canvas>
  </div>
</div>

<script>
  // === –¢–í–û–ô FIREBASE CONFIG ===
  const firebaseConfig = {
    apiKey: "AIzaSyB03njAHYVQ2VI5-0-rOTR39pW0ggPqDus",
    authDomain: "ball-game-53e49.firebaseapp.com",
    databaseURL: "https://ball-game-53e49-default-rtdb.firebaseio.com",
    projectId: "ball-game-53e49",
    storageBucket: "ball-game-53e49.firebasestorage.app",
    messagingSenderId: "895128807264",
    appId: "1:895128807264:web:019538a33ed810c55ba005"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let currentUser = null;
  let currentRoom = null;
  let playerId = null;
  let players = {};
  let score = 0;
  let gameTime = 60;
  let gameActive = false;
  let canvas, ctx, minimapCtx;
  const WORLD_WIDTH = 1500;
  const WORLD_HEIGHT = 1000;

  // === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(error => {
      console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    });
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
      loadFriends();
      loadLeaderboard();
    } else {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('menu').style.display = 'none';
    }
  });

  // === –í–ö–õ–ê–î–ö–ò ===
  function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('friendsList').style.display = tab === 'friends' ? 'block' : 'none';
    document.getElementById('leaderboard').style.display = tab === 'leaderboard' ? 'block' : 'none';
  }

  // === –î–†–£–ó–¨–Ø (–æ–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–∏) ===
  function loadFriends() {
    const friendsList = document.getElementById('friendsList');
    friendsList.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    database.ref('rooms').once('value', snapshot => {
      const friends = new Set();
      snapshot.forEach(roomSnap => {
        const roomData = roomSnap.val();
        if (roomData && roomData.players) {
          Object.values(roomData.players).forEach(player => {
            if (player && player.name) {
              friends.add(player.name);
            }
          });
        }
      });
      friendsList.innerHTML = '';
      if (friends.size === 0) {
        friendsList.innerHTML = '<div style="color:#666;">–ù–µ—Ç –¥—Ä—É–∑–µ–π –æ–Ω–ª–∞–π–Ω</div>';
        return;
      }
      friends.forEach(name => {
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.textContent = name;
        friendsList.appendChild(div);
      });
    });
  }

  // === –õ–ò–î–ï–†–ë–û–†–î ===
  function loadLeaderboard() {
    const board = document.getElementById('leaderboard');
    board.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    database.ref('leaderboard').orderByChild('score').limitToLast(10).once('value', snapshot => {
      const leaders = [];
      snapshot.forEach(child => {
        leaders.push({ name: child.val().name, score: child.val().score });
      });
      leaders.reverse();
      board.innerHTML = '';
      if (leaders.length === 0) {
        board.innerHTML = '<div style="color:#666;">–ù–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
        return;
      }
      leaders.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'leader-item';
        div.textContent = `${i+1}. ${item.name}: ${item.score}`;
        board.appendChild(div);
      });
    });
  }

  // === –í–•–û–î –í –ò–ì–†–£ ===
  function joinGame() {
    const roomIdInput = document.getElementById('roomIdInput');
    currentRoom = roomIdInput.value.trim() || 'clicker-room';
    playerId = currentUser.uid;
    
    document.getElementById('menu').style.display = 'none';
    document.getElementById('gameUI').style.display = 'block';
    
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    const minimap = document.getElementById('minimap');
    minimapCtx = minimap.getContext('2d');
    
    // –°–ø–∞–≤–Ω –∏–≥—Ä–æ–∫–∞
    const startX = Math.random() * (WORLD_WIDTH - 100) + 50;
    const startY = Math.random() * (WORLD_HEIGHT - 100) + 50;
    players[playerId] = { x: startX, y: startY, name: currentUser.displayName || "Player" };
    
    const roomRef = database.ref(`rooms/${currentRoom}`);
    roomRef.child(`players/${playerId}`).set(players[playerId]);
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
    roomRef.child('players').on('value', snapshot => {
      players = snapshot.val() || {};
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
    roomRef.child(`players/${playerId}`).onDisconnect().remove();
    
    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
    score = 0;
    gameTime = 60;
    gameActive = true;
    document.getElementById('scoreDisplay').textContent = `–°—á—ë—Ç: ${score}`;
    document.getElementById('timeDisplay').textContent = `–í—Ä–µ–º—è: ${gameTime}`;
    
    // –¢–∞–π–º–µ—Ä
    const timer = setInterval(() => {
      if (!gameActive) {
        clearInterval(timer);
        return;
      }
      gameTime--;
      document.getElementById('timeDisplay').textContent = `–í—Ä–µ–º—è: ${gameTime}`;
      if (gameTime <= 0) {
        endGame();
        clearInterval(timer);
      }
    }, 1000);
    
    // –ö–ª–∏–∫ –ø–æ –º—è—á—É = +1
    canvas.addEventListener('click', handleCanvasClick);
    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      handleCanvasClick(e.touches[0]);
    });
    
    gameLoop();
  }

  // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–ê (–ó–ê–©–ò–¢–ê –û–¢ –ß–ò–¢–û–í) ===
  function handleCanvasClick(clientPoint) {
    if (!gameActive) return;
    
    const rect = canvas.getBoundingClientRect();
    const clickX = clientPoint.clientX - rect.left;
    const clickY = clientPoint.clientY - rect.top;
    
    // –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π –º—è—á
    let closestPlayer = null;
    let minDist = 50; // —Ä–∞–¥–∏—É—Å –∫–ª–∏–∫–∞
    
    for (const id in players) {
      const p = players[id];
      if (!p) continue;
      const dist = Math.sqrt((p.x - clickX) ** 2 + (p.y - clickY) ** 2);
      if (dist < minDist) {
        minDist = dist;
        closestPlayer = id;
      }
    }
    
    if (closestPlayer === playerId) {
      // –ó–∞—â–∏—Ç–∞: –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º –∫–ª–∏–∫–∞—Ç—å —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
      if (Date.now() - (window.lastClick || 0) < 100) return;
      window.lastClick = Date.now();
      
      score++;
      document.getElementById('scoreDisplay').textContent = `–°—á—ë—Ç: ${score}`;
      
      // === –≠–ú–£–õ–Ø–¶–ò–Ø –ó–ê–©–ò–¢–´ –û–¢ –ß–ò–¢–û–í ===
      // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç Cloud Function
      const clickData = {
        playerId: playerId,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        clickX: clickX,
        clickY: clickY
      };
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: –∫–ª–∏–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç–∫—Ä–∞–Ω–∞
      if (clickX >= 0 && clickX <= WORLD_WIDTH && clickY >= 0 && clickY <= WORLD_HEIGHT) {
        // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –≤—ã–∑–æ–≤ Cloud Function –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º
        database.ref(`clicks/${currentRoom}/${Date.now()}`).set(clickData);
      }
    }
  }

  // === –û–ö–û–ù–ß–ê–ù–ò–ï –ò–ì–†–´ ===
  function endGame() {
    gameActive = false;
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    const leaderboardRef = database.ref('leaderboard').push();
    leaderboardRef.set({
      name: currentUser.displayName || "Anonymous",
      score: score,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à —Å—á—ë—Ç: ${score}`);
    leaveGame();
  }

  // === –í–´–•–û–î –ò–ó –ò–ì–†–´ ===
  function leaveGame() {
    if (currentRoom && playerId) {
      database.ref(`rooms/${currentRoom}/players/${playerId}`).remove();
    }
    currentRoom = null;
    players = {};
    document.getElementById('gameUI').style.display = 'none';
    document.getElementById('menu').style.display = 'flex';
    loadFriends(); // –æ–±–Ω–æ–≤–∏—Ç—å –¥—Ä—É–∑–µ–π
  }

  // === –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ===
  function gameLoop() {
    if (!gameActive) return;
    
    // –û—á–∏—Å—Ç–∫–∞
    ctx.clearRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
    
    // –ö–ª–µ—Ç—á–∞—Ç–∞—è –∑–µ–º–ª—è
    const cellSize = 50;
    for (let x = 0; x < WORLD_WIDTH; x += cellSize) {
      for (let y = 0; y < WORLD_HEIGHT; y += cellSize) {
        const isLight = (Math.floor(x / cellSize) + Math.floor(y / cellSize)) % 2 === 0;
        ctx.fillStyle = isLight ? '#2ecc71' : '#27ae60';
        ctx.fillRect(x, y, cellSize, cellSize);
      }
    }
    
    // –ò–≥—Ä–æ–∫–∏
    for (const id in players) {
      const p = players[id];
      if (!p) continue;
      
      // –ú—è—á
      ctx.fillStyle = id === playerId ? '#3498db' : '#e74c3c';
      ctx.beginPath();
      ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
      ctx.fill();
      
      // –ì–ª–∞–∑–∞
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(p.x - 6, p.y - 4, 5, 0, Math.PI * 2);
      ctx.arc(p.x + 6, p.y - 4, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = 'black';
      ctx.beginPath();
      ctx.arc(p.x - 6, p.y - 4, 2, 0, Math.PI * 2);
      ctx.arc(p.x + 6, p.y - 4, 2, 0, Math.PI * 2);
      ctx.fill();
      
      // –ù–∏–∫
      ctx.fillStyle = 'white';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(p.name, p.x, p.y - 30);
    }
    
    // –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞
    minimapCtx.fillStyle = '#0a0a14';
    minimapCtx.fillRect(0, 0, 120, 80);
    minimapCtx.strokeStyle = '#4ecca3';
    minimapCtx.strokeRect(0, 0, 120, 80);
    
    const mapScaleX = 120 / WORLD_WIDTH;
    const mapScaleY = 80 / WORLD_HEIGHT;
    for (const id in players) {
      const p = players[id];
      if (!p) continue;
      const mx = p.x * mapScaleX;
      const my = p.y * mapScaleY;
      minimapCtx.fillStyle = id === playerId ? '#3498db' : '#e74c3c';
      minimapCtx.beginPath();
      minimapCtx.arc(mx, my, 3, 0, Math.PI * 2);
      minimapCtx.fill();
    }
    
    requestAnimationFrame(gameLoop);
  }

  // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –î–†–£–ó–ï–ô –ö–ê–ñ–î–´–ï 5 –°–ï–ö ===
  setInterval(loadFriends, 5000);
</script>

</body>
</html>